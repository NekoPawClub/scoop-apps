name: AutoMirror

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  automirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“‚ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true  # ç¡®ä¿å¯ç”¨ LFS æ”¯æŒ

      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: ğŸš€ è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
        run: node automirror.mjs

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ–‡ä»¶å˜æ›´
          if [ -z "$(git status --porcelain)" ]; then
            echo "::set-output name=has_changes::false"
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            echo "::set-output name=has_changes::true"
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          fi

      - name: ğŸ“ æäº¤æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é…ç½® Git ç”¨æˆ·
          git config user.email "actions@github.com"
          git config user.name "GitHub_Actions"
          
          # ä»…æ·»åŠ å·²è·Ÿè¸ªæ–‡ä»¶çš„å˜æ›´ (é¿å…æ·»åŠ æœªè·Ÿè¸ªæ–‡ä»¶)
          git add -u
          
          # ç‰¹æ®Šæ·»åŠ  .gitattributes ä»¥é˜²è¢«ä¿®æ”¹
          git add .gitattributes 2>/dev/null || true
          
          # æäº¤æ¶ˆæ¯å¤„ç†
          if [ -f commit.txt ]; then
            COMMIT_MSG=$(cat commit.txt)
            rm -f commit.txt
          else
            COMMIT_MSG="AutoMirror: è‡ªåŠ¨åŒæ­¥æ›´æ–°"
          fi
          
          # åˆ›å»ºæäº¤
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€å˜æ›´ (LFS æ–‡ä»¶ä¼šè‡ªåŠ¨å¤„ç†)
          git push origin main